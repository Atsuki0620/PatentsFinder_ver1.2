# --------------------------------------------
# 1. å…±é€šè¨­å®šãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# --------------------------------------------
import streamlit as st
from langchain_openai import ChatOpenAI
from langchain.schema import HumanMessage, AIMessage, SystemMessage

# --------------------------------------------
# 2. ãƒšãƒ¼ã‚¸è¨­å®šãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜
# --------------------------------------------
st.set_page_config(page_title="ğŸ’¡ PatentsFinder ver1.2", page_icon="ğŸ”")
st.title("ğŸ” PatentsFinder ver1.2")
st.write("""
ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ä¼šè©±ã‚’é€šã˜ã¦ã€Œç‰¹è¨±èª¿æŸ»ã«å¿…è¦ãª IPC (International Patent Classification) ã‚³ãƒ¼ãƒ‰ã€ã‚’çµã‚Šè¾¼ã‚€ãŸã‚ã® AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
1. å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã¾ãŸã¯ä¸‹éƒ¨ï¼‰ã®å…¥åŠ›æ¬„ã« OpenAI API Key ã‚’å…¥åŠ›  
2. ã€èª¿æŸ»ã—ãŸã„æŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã‚’ä¼šè©±å½¢å¼ã§å…¥åŠ›ã™ã‚‹ã¨ã€AI ãŒé–¢é€£ã™ã‚‹ IPC ã‚³ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã¾ã™ã€‚  
3. ææ¡ˆã•ã‚ŒãŸ IPC ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ã€å®Ÿéš›ã®ç‰¹è¨±æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§èª¿æŸ»ã§ãã¾ã™ã€‚
""")

# --------------------------------------------
# 3. ã‚µã‚¤ãƒ‰ãƒãƒ¼ or æœ€ä¸Šéƒ¨ï¼šAPI ã‚­ãƒ¼å…¥åŠ›
# --------------------------------------------
# ï¼ˆâ€» ç”»é¢ä¸Šéƒ¨ã«ç›´æ¥ç½®ãã‹ã€st.sidebar ã‚’ä½¿ã†ã‹ã¯å¥½ã¿ã§å¤‰æ›´å¯ï¼‰
openai_api_key = st.text_input("OpenAI API Key", type="password")
if not openai_api_key:
    st.info("ã¾ãšã¯ OpenAI API Key ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", icon="ğŸ—ï¸")
    st.stop()

# --------------------------------------------
# 4. LangChain ã® LLM ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
#    â”€â”€ â€œAI ã®å½¹å‰²â€ ã‚’å®šç¾©ã™ã‚‹ system_prompt ã‚’å«ã‚ã‚‹
# --------------------------------------------
SYSTEM_PROMPT = """
ã‚ãªãŸã¯ç‰¹è¨±èª¿æŸ»ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸæŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ã€é–¢é€£æ€§ã®é«˜ã„æŠ€è¡“åˆ†é‡ã‚„ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯ã‚’ã„ãã¤ã‹è‡ªç„¶ãªæ—¥æœ¬èªã§ææ¡ˆã—ã¦ãã ã•ã„ã€‚IPCã‚³ãƒ¼ãƒ‰ã‚„ç‰¹è¨±åˆ†é¡ç•ªå·ã«ã¯è¨€åŠã›ãšã€ç´”ç²‹ã«æŠ€è¡“çš„è¦–ç‚¹ã§ä»¥ä¸‹ã‚’è¡Œã„ã¾ã™ã€‚
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®è§£æ
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã¾ã™ã€‚
2. é–¢é€£æŠ€è¡“ã®ææ¡ˆ
    æŠ½å‡ºã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ãã€è©²å½“åˆ†é‡ã®ä»£è¡¨çš„ãªæŠ€è¡“ã‚„æœ€æ–°å‹•å‘ã€å¿œç”¨ä¾‹ãªã©ã‚’2ï½4é …ç›®ç¨‹åº¦ã€é …ç›®ã”ã¨ã«ç•ªå·ã‚’æŒ¯ã£ã¦ã€è‡ªç„¶æ–‡ã§ã‚ã‹ã‚Šã‚„ã™ãææ¡ˆã—ã¾ã™ã€‚
    ãŸã¨ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œé€†æµ¸é€è†œã®æ©Ÿæ¢°å­¦ç¿’ã€ã¨å…¥åŠ›ã—ãŸå ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«å›ç­”ã—ã¾ã™ã€‚
    ã€€1.é€†æµ¸é€è†œãƒ—ãƒ­ã‚»ã‚¹ã«ãŠã‘ã‚‹é‹è»¢æ¡ä»¶æœ€é©åŒ–ã®ãŸã‚ã®æ©Ÿæ¢°å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é–‹ç™º
    ã€€2.ã‚»ãƒ³ã‚µãƒ¼åé›†ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ãŸè†œæ±šæŸ“æ¤œçŸ¥ãŠã‚ˆã³äºˆæ¸¬æŠ€è¡“
    ã€€3.AIã‚’æ´»ç”¨ã—ãŸè†œè£½é€ å·¥ç¨‹ã§ã®ææ–™é¸å®šã¨å“è³ªç®¡ç†
"""



llm = ChatOpenAI(
    model_name="gpt-3.5-turbo", 
    openai_api_key=openai_api_key,
    temperature=0.2  # IPC çµã‚Šè¾¼ã¿ã§ã¯ã‚ã¾ã‚Šãƒ–ãƒ¬ã‚’æŒãŸã›ãªã„ãŸã‚ã‚„ã‚„ä½ã‚
)

# --------------------------------------------
# 5. session_state ã§ä¼šè©±å±¥æ­´ã‚’ç®¡ç†
# --------------------------------------------
# {"role":"user"/"assistant"/"system", "content": "..."} ã®ãƒªã‚¹ãƒˆã‚’ä¿æŒ
if "messages" not in st.session_state:
    # åˆå›èµ·å‹•æ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŒ¿å…¥ã—ã¦ãŠã
    st.session_state.messages = [
        {"role": "system", "content": SYSTEM_PROMPT}
    ]

# --------------------------------------------
# 6. æ—¢å­˜ã®ä¼šè©±å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆsystem ã¯è¡¨ç¤ºã›ãš user/assistant ã®ã¿æç”»ï¼‰
# --------------------------------------------
for msg in st.session_state.messages:
    if msg["role"] in ["user", "assistant"]:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

# --------------------------------------------
# 7. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
# --------------------------------------------
if prompt := st.chat_input("èª¿æŸ»ã—ãŸã„æŠ€è¡“é ˜åŸŸãƒ»å¯¾è±¡æœŸé–“ãƒ»å‡ºé¡˜å›½ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"):

    # 7-1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ ãƒ»è¡¨ç¤º
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

     # 7-2. LangChain ç”¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ HumanMessage/AIMessage/SystemMessage ã«å¤‰æ›
    lc_messages = []
    for m in st.session_state.messages:
        if m["role"] == "user":
            lc_messages.append(HumanMessage(content=m["content"]))
        elif m["role"] == "assistant":
            lc_messages.append(AIMessage(content=m["content"]))
        elif m["role"] == "system":
            lc_messages.append(SystemMessage(content=m["content"]))

    # 7-3. LLM ã«å•ã„åˆã‚ã›ï¼ˆIPC ã‚³ãƒ¼ãƒ‰ã‚’çµã‚Šè¾¼ã‚€å½¹å‰²ã®ã¾ã¾å¿œç­”ï¼‰
    # â€» LangChain v0.1 ç³»ã§ã¯ system ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªå‹•æ¤œå‡ºã—ãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€
    #    ãã®éš›ã¯ ChatPromptTemplate ã‚’ä½¿ã£ã¦ system ã¨ user ã‚’åˆ†é›¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    #    ã“ã“ã§ã¯å˜ç´”åŒ–ã—ã¦ã€Œlc_messages ã« system/user ã‚’æ··åœ¨ã•ã›ã‚‹å½¢ã€ã‚’æƒ³å®šã€‚
    response = llm(lc_messages)
    ai_content = response.content

    # 7-4. AI ã®å¿œç­”ã‚’è¡¨ç¤ºãƒ»å±¥æ­´ã«è¿½åŠ 
    with st.chat_message("assistant"):
        st.markdown(ai_content)
    st.session_state.messages.append({"role": "assistant", "content": ai_content})

# --------------------------------------------
# 8. ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ææ¡ˆ IPC ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’æŠ½å‡ºã—ã¦ã‚µãƒãƒªè¡¨ç¤º
# --------------------------------------------
# AI ã®å›ç­”ã¯ Markdown å½¢å¼ã§ IPC ã‚³ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’è¿”ã™æƒ³å®šãªã®ã§ã€
# å¿…è¦ã«å¿œã˜ã¦ã€Œã‚³ãƒ¼ãƒ‰ã ã‘æŠœãå‡ºã—ã¦å³ãƒšã‚¤ãƒ³ã«è¡¨ç¤ºã™ã‚‹ã€ãªã©å®Ÿè£…å¯ã€‚
# ä¾‹ï¼š
if "assistant" in [m["role"] for m in st.session_state.messages]:
    # æœ€å¾Œã® assist ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è§£æã—ã¦ IPC ã‚³ãƒ¼ãƒ‰ã‚’ç®‡æ¡æ›¸ãã ã‘æŠ½å‡ºã—ã€æ¨ªã«è¡¨ç¤ºã™ã‚‹ãªã©
    last_ai = st.session_state.messages[-1]["content"]
    # ç°¡æ˜“çš„ã«ã€Œè¡Œé ­ãŒæ•°å­—. ã€œã€ã‚’æ­£è¦è¡¨ç¾ã§æ‹¾ã†ãªã©ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã§ãã‚‹
    # ã“ã®éƒ¨åˆ†ã¯å¾Œæ®µã® â€œæ‹¡å¼µãƒã‚¤ãƒ³ãƒˆâ€ ã§ç´¹ä»‹
    # st.sidebar.markdown("### ææ¡ˆã•ã‚ŒãŸ IPC ã‚³ãƒ¼ãƒ‰")
    # st.sidebar.markdown(æŠœãå‡ºã—ãŸãƒªã‚¹ãƒˆã‚’ Markdown åŒ–ã—ã¦è¡¨ç¤º)
    pass


# ãŠã¾ã‘ã®ãƒ†ã‚¹ãƒˆ
# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ä½¿ç”¨ä¾‹
option = st.sidebar.selectbox('ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠ', ['ã‚ªãƒ—ã‚·ãƒ§ãƒ³1', 'ã‚ªãƒ—ã‚·ãƒ§ãƒ³2', 'ã‚ªãƒ—ã‚·ãƒ§ãƒ³3'])
st.write(f'é¸æŠã—ãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ {option} ã§ã™ã€‚')

# ã‚«ãƒ©ãƒ ã®ä½¿ç”¨ä¾‹
column1, column2, column3 = st.columns(3)
with column1:
    st.write('ã“ã‚Œã¯ã‚«ãƒ©ãƒ 1ã§ã™ã€‚')
with column2:
    st.write('ã“ã‚Œã¯ã‚«ãƒ©ãƒ 2ã§ã™ã€‚')
with column3:
    st.write('ã“ã‚Œã¯ã‚«ãƒ©ãƒ 3ã§ã™ã€‚')

col1, col2 = st.columns([2, 3])
col1.metric(label="ãƒ¡ãƒˆãƒªãƒƒã‚¯1", value=123)
col2.metric(label="ãƒ¡ãƒˆãƒªãƒƒã‚¯2", value=456)


with st.expander("ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹"):
    st.write("éè¡¨ç¤ºã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„")
