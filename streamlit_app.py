# --------------------------------------------
# 1. å…±é€šè¨­å®šãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# --------------------------------------------
import streamlit as st
from langchain_openai import ChatOpenAI
from langchain.schema import HumanMessage, AIMessage, SystemMessage

# --------------------------------------------
# 2. ãƒšãƒ¼ã‚¸è¨­å®šãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜
# --------------------------------------------
st.set_page_config(page_title="ğŸ’¡ PatentsFinder ver1.2", page_icon="ğŸ”")
st.title("ğŸ” PatentsFinder ver1.2")
st.write("""
ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ä¼šè©±ã‚’é€šã˜ã¦ã€Œç‰¹è¨±èª¿æŸ»ã«å¿…è¦ãª IPC (International Patent Classification) ã‚³ãƒ¼ãƒ‰ã€ã‚’çµã‚Šè¾¼ã‚€ãŸã‚ã® AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
1. å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã¾ãŸã¯ä¸‹éƒ¨ï¼‰ã®å…¥åŠ›æ¬„ã« OpenAI API Key ã‚’å…¥åŠ›  
2. ã€èª¿æŸ»ã—ãŸã„æŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã‚’ä¼šè©±å½¢å¼ã§å…¥åŠ›ã™ã‚‹ã¨ã€AI ãŒé–¢é€£ã™ã‚‹ IPC ã‚³ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã¾ã™ã€‚  
3. ææ¡ˆã•ã‚ŒãŸ IPC ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ã€å®Ÿéš›ã®ç‰¹è¨±æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§èª¿æŸ»ã§ãã¾ã™ã€‚
""")

# --------------------------------------------
# 3. ã‚µã‚¤ãƒ‰ãƒãƒ¼ or æœ€ä¸Šéƒ¨ï¼šAPI ã‚­ãƒ¼å…¥åŠ›
# --------------------------------------------
# ï¼ˆâ€» ç”»é¢ä¸Šéƒ¨ã«ç›´æ¥ç½®ãã‹ã€st.sidebar ã‚’ä½¿ã†ã‹ã¯å¥½ã¿ã§å¤‰æ›´å¯ï¼‰
openai_api_key = st.text_input("OpenAI API Key", type="password")
if not openai_api_key:
    st.info("ã¾ãšã¯ OpenAI API Key ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", icon="ğŸ—ï¸")
    st.stop()

# --------------------------------------------
# 4. LangChain ã® LLM ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
#    â”€â”€ â€œAI ã®å½¹å‰²â€ ã‚’å®šç¾©ã™ã‚‹ system_prompt ã‚’å«ã‚ã‚‹
# --------------------------------------------
SYSTEM_PROMPT = """
ã‚ãªãŸã¯ã€Œç‰¹è¨±èª¿æŸ»ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª¿æŸ»ã—ãŸã„æŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€é–¢é€£ã™ã‚‹ IPC ã‚³ãƒ¼ãƒ‰ã‚’ 3ï½5 å€‹ç¨‹åº¦ã€ç°¡æ½”ã«ææ¡ˆã—ã¦ãã ã•ã„ã€‚
å„ IPC ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ã€å…·ä½“çš„ãªæŠ€è¡“ç¯„å›²ã‚’ä¸€è¨€ã§èª¬æ˜ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã©ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ãˆã°ã‚ˆã„ã‹é¸ã³ã‚„ã™ã„ã‚ˆã†ã«ç¤ºã—ã¦ãã ã•ã„ã€‚
ãªãŠã€IPC ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªåˆ†é¡ä½“ç³»ã‚’æŒã¡ã¾ã™ãŒã€ã‚ãã¾ã§ã€Œå¤§åˆ†é¡â€å°åˆ†é¡â€ç´°åˆ†é¡ã¾ã§ã€ç¤ºã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
ä¾‹ï¼š
G06Fï¼šé›»å­è¨ˆç®—æ©Ÿã«é–¢ã™ã‚‹æŠ€è¡“  
ï¼ˆä¾‹ï¼šG06F 9/30 ãªã©ï¼‰

â–  å¿œç­”ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹ï¼ˆMarkdownï¼‰ï¼š
1. `G06F 9/30` ï¼š ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ åˆ¶å¾¡ã«é–¢ã™ã‚‹æŠ€è¡“  
2. `G06F 3/01` ï¼š ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æ§‹é€ ã«é–¢ã™ã‚‹æŠ€è¡“  
3. `H01L 21/00`ï¼š åŠå°ä½“ãƒ‡ãƒã‚¤ã‚¹è£½é€ ã«é–¢ã™ã‚‹æŠ€è¡“  
â€¦  
ä»¥ä¸Šã®ã‚ˆã†ã«ç®‡æ¡æ›¸ãã§ç¤ºã—ã€æœ€å¾Œã«ã€Œç‰¹è¨±æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ã“ã® IPC ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦èª¿æŸ»ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã€ã¨ä¸€æ–‡æ·»ãˆã¦ãã ã•ã„ã€‚
"""

llm = ChatOpenAI(
    model_name="gpt-3.5-turbo", 
    openai_api_key=openai_api_key,
    temperature=0.2  # IPC çµã‚Šè¾¼ã¿ã§ã¯ã‚ã¾ã‚Šãƒ–ãƒ¬ã‚’æŒãŸã›ãªã„ãŸã‚ã‚„ã‚„ä½ã‚
)

# --------------------------------------------
# 5. session_state ã§ä¼šè©±å±¥æ­´ã‚’ç®¡ç†
# --------------------------------------------
# {"role":"user"/"assistant"/"system", "content": "..."} ã®ãƒªã‚¹ãƒˆã‚’ä¿æŒ
if "messages" not in st.session_state:
    # åˆå›èµ·å‹•æ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŒ¿å…¥ã—ã¦ãŠã
    st.session_state.messages = [
        {"role": "system", "content": SYSTEM_PROMPT}
    ]

# --------------------------------------------
# 6. æ—¢å­˜ã®ä¼šè©±å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆsystem ã¯è¡¨ç¤ºã›ãš user/assistant ã®ã¿æç”»ï¼‰
# --------------------------------------------
for msg in st.session_state.messages:
    if msg["role"] in ["user", "assistant"]:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

# --------------------------------------------
# 7. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
# --------------------------------------------
if prompt := st.chat_input("èª¿æŸ»ã—ãŸã„æŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"):

    # 7-1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ ãƒ»è¡¨ç¤º
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

     # 7-2. LangChain ç”¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ HumanMessage/AIMessage/SystemMessage ã«å¤‰æ›
    lc_messages = []
    for m in st.session_state.messages:
        if m["role"] == "user":
            lc_messages.append(HumanMessage(content=m["content"]))
        elif m["role"] == "assistant":
            lc_messages.append(AIMessage(content=m["content"]))
        elif m["role"] == "system":
            lc_messages.append(SystemMessage(content=m["content"]))

    # 7-3. LLM ã«å•ã„åˆã‚ã›ï¼ˆIPC ã‚³ãƒ¼ãƒ‰ã‚’çµã‚Šè¾¼ã‚€å½¹å‰²ã®ã¾ã¾å¿œç­”ï¼‰
    # â€» LangChain v0.1 ç³»ã§ã¯ system ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªå‹•æ¤œå‡ºã—ãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€
    #    ãã®éš›ã¯ ChatPromptTemplate ã‚’ä½¿ã£ã¦ system ã¨ user ã‚’åˆ†é›¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    #    ã“ã“ã§ã¯å˜ç´”åŒ–ã—ã¦ã€Œlc_messages ã« system/user ã‚’æ··åœ¨ã•ã›ã‚‹å½¢ã€ã‚’æƒ³å®šã€‚
    response = llm(lc_messages)
    ai_content = response.content

    # 7-4. AI ã®å¿œç­”ã‚’è¡¨ç¤ºãƒ»å±¥æ­´ã«è¿½åŠ 
    with st.chat_message("assistant"):
        st.markdown(ai_content)
    st.session_state.messages.append({"role": "assistant", "content": ai_content})

# --------------------------------------------
# 8. ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ææ¡ˆ IPC ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’æŠ½å‡ºã—ã¦ã‚µãƒãƒªè¡¨ç¤º
# --------------------------------------------
# AI ã®å›ç­”ã¯ Markdown å½¢å¼ã§ IPC ã‚³ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’è¿”ã™æƒ³å®šãªã®ã§ã€
# å¿…è¦ã«å¿œã˜ã¦ã€Œã‚³ãƒ¼ãƒ‰ã ã‘æŠœãå‡ºã—ã¦å³ãƒšã‚¤ãƒ³ã«è¡¨ç¤ºã™ã‚‹ã€ãªã©å®Ÿè£…å¯ã€‚
# ä¾‹ï¼š
if "assistant" in [m["role"] for m in st.session_state.messages]:
    # æœ€å¾Œã® assist ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è§£æã—ã¦ IPC ã‚³ãƒ¼ãƒ‰ã‚’ç®‡æ¡æ›¸ãã ã‘æŠ½å‡ºã—ã€æ¨ªã«è¡¨ç¤ºã™ã‚‹ãªã©
    last_ai = st.session_state.messages[-1]["content"]
    # ç°¡æ˜“çš„ã«ã€Œè¡Œé ­ãŒæ•°å­—. ã€œã€ã‚’æ­£è¦è¡¨ç¾ã§æ‹¾ã†ãªã©ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã§ãã‚‹
    # ã“ã®éƒ¨åˆ†ã¯å¾Œæ®µã® â€œæ‹¡å¼µãƒã‚¤ãƒ³ãƒˆâ€ ã§ç´¹ä»‹
    # st.sidebar.markdown("### ææ¡ˆã•ã‚ŒãŸ IPC ã‚³ãƒ¼ãƒ‰")
    # st.sidebar.markdown(æŠœãå‡ºã—ãŸãƒªã‚¹ãƒˆã‚’ Markdown åŒ–ã—ã¦è¡¨ç¤º)
    pass
