# --------------------------------------------
# 1. å…±é€šè¨­å®šãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# --------------------------------------------
import streamlit as st
from langchain_openai import ChatOpenAI
from langchain.schema import HumanMessage, AIMessage, SystemMessage

# --------------------------------------------
# 2. ãƒšãƒ¼ã‚¸è¨­å®šãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜
# --------------------------------------------
st.set_page_config(page_title="ğŸ’¡ PatentsFinder ver1.2", page_icon="ğŸ”")
st.title("ğŸ” PatentsFinder ver1.2")
st.write("""
ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ä¼šè©±ã‚’é€šã˜ã¦ã€Œç‰¹è¨±èª¿æŸ»ã«å¿…è¦ãª IPC (International Patent Classification) ã‚³ãƒ¼ãƒ‰ã€ã‚’çµã‚Šè¾¼ã‚€ãŸã‚ã® AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
1. å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã¾ãŸã¯ä¸‹éƒ¨ï¼‰ã®å…¥åŠ›æ¬„ã« OpenAI API Key ã‚’å…¥åŠ›  
2. ã€èª¿æŸ»ã—ãŸã„æŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã‚’ä¼šè©±å½¢å¼ã§å…¥åŠ›ã™ã‚‹ã¨ã€AI ãŒé–¢é€£ã™ã‚‹ IPC ã‚³ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã¾ã™ã€‚  
3. ææ¡ˆã•ã‚ŒãŸ IPC ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ã€å®Ÿéš›ã®ç‰¹è¨±æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§èª¿æŸ»ã§ãã¾ã™ã€‚
""")

# --------------------------------------------
# 3. ã‚µã‚¤ãƒ‰ãƒãƒ¼ or æœ€ä¸Šéƒ¨ï¼šAPI ã‚­ãƒ¼å…¥åŠ›
# --------------------------------------------
# ï¼ˆâ€» ç”»é¢ä¸Šéƒ¨ã«ç›´æ¥ç½®ãã‹ã€st.sidebar ã‚’ä½¿ã†ã‹ã¯å¥½ã¿ã§å¤‰æ›´å¯ï¼‰
openai_api_key = st.text_input("OpenAI API Key", type="password")
if not openai_api_key:
    st.info("ã¾ãšã¯ OpenAI API Key ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", icon="ğŸ—ï¸")
    st.stop()

# --------------------------------------------
# 4. LangChain ã® LLM ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
#    â”€â”€ â€œAI ã®å½¹å‰²â€ ã‚’å®šç¾©ã™ã‚‹ system_prompt ã‚’å«ã‚ã‚‹
# --------------------------------------------
SYSTEM_PROMPT = """
ã‚ãªãŸã¯ç‰¹è¨±èª¿æŸ»ã‚¯ã‚¨ãƒªã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€æ—¥ä»˜ã€å›½ã‚’è‡ªç”±å½¢å¼ã§ä¸€åº¦ã«å…¥åŠ›ã—ã¾ã™ã€‚AIã¯ä»¥ä¸‹ã®æµã‚Œã§é€²ã‚ã€æœ€çµ‚çš„ã«JSONå½¢å¼ã®æ¤œç´¢æ¡ä»¶ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚ä¸è¶³ãŒã‚ã‚Œã°ã¾ã¨ã‚ã¦è³ªå•ã—ã€æƒ…å ±ãŒæƒãˆã°è¿½åŠ è³ªå•ãªã—ã«å®Œçµã—ã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®è§£æ
publication_fromï¼ˆå…¬é–‹æ—¥ä¸‹é™ï¼‰ã€countriesï¼ˆå›½ã‚³ãƒ¼ãƒ‰ï¼‰ã€keywordsï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰ãŒå«ã¾ã‚Œã‚Œã°æŠ½å‡º
ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®IPCã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Œã°ãã®ã¾ã¾ä½¿ç”¨
æŒ‡å®šãŒãªã‘ã‚Œã°keywordsã‹ã‚‰é–¢é€£IPCã‚³ãƒ¼ãƒ‰ã‚’3ï½5å€‹ä¸€è¨€èª¬æ˜ä»˜ãã§è‡ªå‹•ç”Ÿæˆã—ã€ç„¦ç‚¹ã¨ã™ã‚‹ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯ã‚’ææ¡ˆã—ã¦ç¢ºèª

IPCã‚³ãƒ¼ãƒ‰ææ¡ˆ
ä¾‹ï¼šå…¥åŠ›ãŒã€Œé€†æµ¸é€è†œã®æ©Ÿæ¢°å­¦ç¿’ã€ãªã‚‰
C02F 1/00ï¼šé€†æµ¸é€è†œè£½é€ ãƒ»åˆ©ç”¨
G06N 3/04ï¼šæ©Ÿæ¢°å­¦ç¿’çŸ¥è­˜å‡¦ç†
G01N 33/569ï¼šè†œæ€§èƒ½è©•ä¾¡
ã€Œæ©Ÿæ¢°å­¦ç¿’ã‚’ç”¨ã„ãŸè£½é€ é«˜æ€§èƒ½åŒ–ã€ã€Œæ€§èƒ½äºˆæ¸¬æŠ€è¡“ã€ã®ã©ã¡ã‚‰ã‹ã€ã‚ã‚‹ã„ã¯åˆ¥ã®æ–¹å‘æ€§ã‚’å°‹ã­ã‚‹

å…¬é–‹æ—¥ã¨å›½ã®ç¢ºèª
IPCãŒç¢ºå®šã—ãŸã‚‰ä¸€åº¦ã«ã€Œå…¬é–‹æ—¥ä¸‹é™ï¼ˆYYYY-MM-DDï¼‰ã¨å›½ã‚³ãƒ¼ãƒ‰ï¼ˆJP, US, CNãªã©ï¼‰ã€ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è³ªå•
ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å†ç¢ºèªï¼ˆå¿…è¦æ™‚ï¼‰
åˆå›å…¥åŠ›ã§keywordsãŒä¸æ˜ç­ãªã‚‰ã€IPCææ¡ˆã¨ä½µã›ã¦è¿½åŠ ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚¹ãƒˆå½¢å¼ã§å°‹ã­ã‚‹
å‡ºåŠ›
ä»¥ä¸‹ã®4é …ç›®ãŒæƒã£ãŸã‚‰è¿½åŠ è³ªå•ãªã—ã«JSONã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å‡ºåŠ›ã—ã€æœ€å¾Œã«ã€Œä»¥ä¸ŠãŒç‰¹è¨±æ¤œç´¢æ¡ä»¶ã«ãªã‚Šã¾ã™â€¦ã€ã¨ä»˜åŠ 
{
  "ipc_codes": ["C02F 1/00", "G06N 3/04", â€¦],
  "publication_from": "YYYY-MM-DD",
  "countries": ["JP", "US", "CN"],
  "keywords": ["é€†æµ¸é€è†œ", "æ©Ÿæ¢°å­¦ç¿’", â€¦]
}

â– æ³¨æ„â– 
IPCã‚³ãƒ¼ãƒ‰ã¯ç•ªå·é¸æŠç¦æ­¢ã€‚ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯ã§æ·±å €ã™ã‚‹
æœ€çµ‚å‡ºåŠ›ä»¥å¤–ã¯JSONä»¥å¤–ã®ä½™è¨ˆãªãƒ†ã‚­ã‚¹ãƒˆç¦æ­¢
publication_fromã¨countriesã¯åŒæ™‚ã«ã¾ã¨ã‚ã¦è³ªå•
"""



llm = ChatOpenAI(
    model_name="gpt-3.5-turbo", 
    openai_api_key=openai_api_key,
    temperature=0.2  # IPC çµã‚Šè¾¼ã¿ã§ã¯ã‚ã¾ã‚Šãƒ–ãƒ¬ã‚’æŒãŸã›ãªã„ãŸã‚ã‚„ã‚„ä½ã‚
)

# --------------------------------------------
# 5. session_state ã§ä¼šè©±å±¥æ­´ã‚’ç®¡ç†
# --------------------------------------------
# {"role":"user"/"assistant"/"system", "content": "..."} ã®ãƒªã‚¹ãƒˆã‚’ä¿æŒ
if "messages" not in st.session_state:
    # åˆå›èµ·å‹•æ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŒ¿å…¥ã—ã¦ãŠã
    st.session_state.messages = [
        {"role": "system", "content": SYSTEM_PROMPT}
    ]

# --------------------------------------------
# 6. æ—¢å­˜ã®ä¼šè©±å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆsystem ã¯è¡¨ç¤ºã›ãš user/assistant ã®ã¿æç”»ï¼‰
# --------------------------------------------
for msg in st.session_state.messages:
    if msg["role"] in ["user", "assistant"]:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

# --------------------------------------------
# 7. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
# --------------------------------------------
if prompt := st.chat_input("èª¿æŸ»ã—ãŸã„æŠ€è¡“é ˜åŸŸãƒ»å¯¾è±¡æœŸé–“ãƒ»å‡ºé¡˜å›½ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"):

    # 7-1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ ãƒ»è¡¨ç¤º
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

     # 7-2. LangChain ç”¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ HumanMessage/AIMessage/SystemMessage ã«å¤‰æ›
    lc_messages = []
    for m in st.session_state.messages:
        if m["role"] == "user":
            lc_messages.append(HumanMessage(content=m["content"]))
        elif m["role"] == "assistant":
            lc_messages.append(AIMessage(content=m["content"]))
        elif m["role"] == "system":
            lc_messages.append(SystemMessage(content=m["content"]))

    # 7-3. LLM ã«å•ã„åˆã‚ã›ï¼ˆIPC ã‚³ãƒ¼ãƒ‰ã‚’çµã‚Šè¾¼ã‚€å½¹å‰²ã®ã¾ã¾å¿œç­”ï¼‰
    # â€» LangChain v0.1 ç³»ã§ã¯ system ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªå‹•æ¤œå‡ºã—ãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€
    #    ãã®éš›ã¯ ChatPromptTemplate ã‚’ä½¿ã£ã¦ system ã¨ user ã‚’åˆ†é›¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    #    ã“ã“ã§ã¯å˜ç´”åŒ–ã—ã¦ã€Œlc_messages ã« system/user ã‚’æ··åœ¨ã•ã›ã‚‹å½¢ã€ã‚’æƒ³å®šã€‚
    response = llm(lc_messages)
    ai_content = response.content

    # 7-4. AI ã®å¿œç­”ã‚’è¡¨ç¤ºãƒ»å±¥æ­´ã«è¿½åŠ 
    with st.chat_message("assistant"):
        st.markdown(ai_content)
    st.session_state.messages.append({"role": "assistant", "content": ai_content})

# --------------------------------------------
# 8. ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ææ¡ˆ IPC ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’æŠ½å‡ºã—ã¦ã‚µãƒãƒªè¡¨ç¤º
# --------------------------------------------
# AI ã®å›ç­”ã¯ Markdown å½¢å¼ã§ IPC ã‚³ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’è¿”ã™æƒ³å®šãªã®ã§ã€
# å¿…è¦ã«å¿œã˜ã¦ã€Œã‚³ãƒ¼ãƒ‰ã ã‘æŠœãå‡ºã—ã¦å³ãƒšã‚¤ãƒ³ã«è¡¨ç¤ºã™ã‚‹ã€ãªã©å®Ÿè£…å¯ã€‚
# ä¾‹ï¼š
if "assistant" in [m["role"] for m in st.session_state.messages]:
    # æœ€å¾Œã® assist ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è§£æã—ã¦ IPC ã‚³ãƒ¼ãƒ‰ã‚’ç®‡æ¡æ›¸ãã ã‘æŠ½å‡ºã—ã€æ¨ªã«è¡¨ç¤ºã™ã‚‹ãªã©
    last_ai = st.session_state.messages[-1]["content"]
    # ç°¡æ˜“çš„ã«ã€Œè¡Œé ­ãŒæ•°å­—. ã€œã€ã‚’æ­£è¦è¡¨ç¾ã§æ‹¾ã†ãªã©ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã§ãã‚‹
    # ã“ã®éƒ¨åˆ†ã¯å¾Œæ®µã® â€œæ‹¡å¼µãƒã‚¤ãƒ³ãƒˆâ€ ã§ç´¹ä»‹
    # st.sidebar.markdown("### ææ¡ˆã•ã‚ŒãŸ IPC ã‚³ãƒ¼ãƒ‰")
    # st.sidebar.markdown(æŠœãå‡ºã—ãŸãƒªã‚¹ãƒˆã‚’ Markdown åŒ–ã—ã¦è¡¨ç¤º)
    pass
