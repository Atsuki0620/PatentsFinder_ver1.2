# --------------------------------------------
# 1. å…±é€šè¨­å®šãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# --------------------------------------------
import streamlit as st
from langchain_openai import ChatOpenAI
from langchain.schema import HumanMessage, AIMessage, SystemMessage

# --------------------------------------------
# 2. ãƒšãƒ¼ã‚¸è¨­å®šãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜
# --------------------------------------------
st.set_page_config(page_title="ğŸ’¡ PatentsFinder ver1.2", page_icon="ğŸ”")
st.title("ğŸ” PatentsFinder ver1.2")
st.write(
    """
    ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ä¼šè©±ã‚’é€šã˜ã¦ã€Œç‰¹è¨±èª¿æŸ»ã«å¿…è¦ãª IPC (International Patent Classification) ã‚³ãƒ¼ãƒ‰ã€ã‚’
    çµã‚Šè¾¼ã‚€ãŸã‚ã® AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

    1. å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã¾ãŸã¯ä¸Šéƒ¨ï¼‰ã®å…¥åŠ›æ¬„ã« OpenAI API Key ã‚’å…¥åŠ›  
    2. ä¸‹éƒ¨ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã€Œèª¿æŸ»ã—ãŸã„æŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã‚’å…¥åŠ›ã—ã€  
       ãƒ»ã€Œé–¢é€£æŠ€è¡“ææ¡ˆã€ã‚’æŠ¼ã™ã¨æŠ€è¡“ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯ã‚’ææ¡ˆ  
       ãƒ»ã€ŒIPCã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€ã‚’æŠ¼ã™ã¨ IPC ã‚³ãƒ¼ãƒ‰æ¡ˆã‚’ç”Ÿæˆ  
    3. å¿œç­”ã¯ä¼šè©±UIã«æµã‚Œã¾ã™ã€‚  
    """
)

# --------------------------------------------
# 3. API ã‚­ãƒ¼å…¥åŠ›
# --------------------------------------------
openai_api_key = st.text_input("OpenAI API Key", type="password")
if not openai_api_key:
    st.info("ã¾ãšã¯ OpenAI API Key ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", icon="ğŸ—ï¸")
    st.stop()

# --------------------------------------------
# 4. LangChain ã® LLM ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
# --------------------------------------------
llm = ChatOpenAI(
    model_name="gpt-3.5-turbo",
    openai_api_key=openai_api_key,
    temperature=0.2
)

# --------------------------------------------
# 5. session_state ã§ä¼šè©±å±¥æ­´ã‚’ç®¡ç†
# --------------------------------------------
if "messages" not in st.session_state:
    st.session_state.messages = []  # {"role": "user"/"assistant", "content": "..."} ã®ãƒªã‚¹ãƒˆ

# --------------------------------------------
# 6. (é–¢æ•°å®šç¾©) é–¢é€£æŠ€è¡“ã‚’ææ¡ˆã™ã‚‹é–¢æ•°
# --------------------------------------------
def suggest_technologies(user_input: str):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã«å¯¾ã—ã€é–¢é€£æ€§ã®é«˜ã„æŠ€è¡“åˆ†é‡ã‚„ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯ã‚’è‡ªç„¶æ–‡ã§ 2ï½4 é …ç›®ç¨‹åº¦ææ¡ˆã™ã‚‹ã€‚
    IPCã‚³ãƒ¼ãƒ‰ã«ã¯ä¸€åˆ‡è¨€åŠã—ãªã„ã€‚
    """
    # ä¼šè©±å±¥æ­´ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’è¿½åŠ 
    st.session_state.messages.append({"role": "user", "content": user_input})

    # SystemMessage: é–¢é€£æŠ€è¡“ææ¡ˆå°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    system_prompt = """
    ã‚ãªãŸã¯ã€Œç‰¹è¨±èª¿æŸ»ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸæŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã€
    é–¢é€£æ€§ã®é«˜ã„æŠ€è¡“åˆ†é‡ã‚„ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯ã‚’ 2ã€œ4 é …ç›®ã€è‡ªç„¶ãªæ—¥æœ¬èªã§ææ¡ˆã—ã¦ãã ã•ã„ã€‚IPCã‚³ãƒ¼ãƒ‰ã‚„ç‰¹è¨±åˆ†é¡ç•ªå·ã«ã¯è¨€åŠã›ãšã€
    ã‚¯ãƒªãƒ¼ãƒ³ã«æŠ€è¡“çš„è¦–ç‚¹ã®ã¿ã§å›ç­”ã—ã¾ã™ã€‚

    ä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œé€†æµ¸é€è†œã®æ©Ÿæ¢°å­¦ç¿’ã€ã¨å…¥åŠ›ã—ãŸå ´åˆã€
     1. é€†æµ¸é€è†œãƒ—ãƒ­ã‚»ã‚¹ã«ãŠã‘ã‚‹é‹è»¢æ¡ä»¶æœ€é©åŒ–ã®ãŸã‚ã®æ©Ÿæ¢°å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é–‹ç™º
     2. ã‚»ãƒ³ã‚µãƒ¼åé›†ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ãŸè†œæ±šæŸ“æ¤œçŸ¥ãŠã‚ˆã³äºˆæ¸¬æŠ€è¡“
     3. AIã‚’æ´»ç”¨ã—ãŸè†œè£½é€ å·¥ç¨‹ã§ã®ææ–™é¸å®šã¨å“è³ªç®¡ç†
    """
    # LangChain ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
    lc_messages = [
        SystemMessage(content=system_prompt),
        HumanMessage(content=user_input)
    ]

    # LLM ã‚³ãƒ¼ãƒ«
    response = llm(lc_messages)
    ai_content = response.content.strip()

    # AI å¿œç­”ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ 
    st.session_state.messages.append({"role": "assistant", "content": ai_content})

    # ç”»é¢ã«è¡¨ç¤º
    with st.chat_message("assistant"):
        st.markdown(ai_content)


# --------------------------------------------
# 7. (é–¢æ•°å®šç¾©) IPCã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
# --------------------------------------------
def generate_ipc_codes(user_input: str):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã«å¯¾ã—ã€é–¢é€£ã™ã‚‹ IPC ã‚³ãƒ¼ãƒ‰ã‚’ 3ã€œ5 å€‹ç¨‹åº¦ææ¡ˆã—ã€
    å„ã‚³ãƒ¼ãƒ‰ã®æŠ€è¡“ç¯„å›²ã‚’ä¸€è¨€ã§èª¬æ˜ã™ã‚‹ã€‚
    """
    # ä¼šè©±å±¥æ­´ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’è¿½åŠ 
    st.session_state.messages.append({"role": "user", "content": user_input})

    # SystemMessage: IPCã‚³ãƒ¼ãƒ‰ç”Ÿæˆå°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    system_prompt = """
    ã‚ãªãŸã¯ã€Œç‰¹è¨±èª¿æŸ»ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸæŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ãã€é–¢é€£æ€§ã®é«˜ã„ IPC ã‚³ãƒ¼ãƒ‰ã‚’ 3ï½5 å€‹ç¨‹åº¦ã€ä¸€è¨€èª¬æ˜ä»˜ãã§ææ¡ˆã—ã¦ãã ã•ã„ã€‚
    ãŸã¨ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œé€†æµ¸é€è†œã®æ©Ÿæ¢°å­¦ç¿’ã€ã¨å…¥åŠ›ã—ãŸå ´åˆã€ä¸‹è¨˜ã®ã‚ˆã†ã«ã€IPCã‚³ãƒ¼ãƒ‰ã¨èª¬æ˜ã‚’ Markdown ã®ç®‡æ¡æ›¸ãã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
     - C02F 1/00ï¼šé€†æµ¸é€è†œã®è£½é€ ã‚„åˆ©ç”¨
     - G06N 3/04ï¼šæ©Ÿæ¢°å­¦ç¿’ã«é–¢é€£ã™ã‚‹çŸ¥è­˜å‡¦ç†
     - G01N 33/569ï¼šé€†æµ¸é€è†œã®æ€§èƒ½è©•ä¾¡
     
    ä»¥ä¸‹ã®**å³å¯†ãª JSON**å½¢å¼ã®æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
    çµ¶å¯¾ã«ä½™è¨ˆãªèª¬æ˜æ–‡ã‚’å«ã¾ãšã€**ç´”ç²‹ãª JSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã ã‘ã‚’è¿”ã—ã¦ãã ã•ã„ï¼š
    {
      "ipc_codes": ["B01D61/02", "B01D61/08", "C02F1/44"],
      "assignees": [],
      "publication_from": "YYYY-MM-DD"
    }
    """
    # LangChain ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
    lc_messages = [
        SystemMessage(content=system_prompt),
        HumanMessage(content=user_input)
    ]

    # LLM ã‚³ãƒ¼ãƒ«
    response = llm(lc_messages)
    ai_content = response.content.strip()

    # AI å¿œç­”ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ 
    st.session_state.messages.append({"role": "assistant", "content": ai_content})

    # ç”»é¢ã«è¡¨ç¤º
    with st.chat_message("assistant"):
        st.markdown(ai_content)


# --------------------------------------------
# 8. ä¼šè©±å±¥æ­´ã‚’ç”»é¢ã«è¡¨ç¤º
# --------------------------------------------
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# --------------------------------------------
# 9. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœã‚¿ãƒ³é…ç½®
# --------------------------------------------
user_input = st.text_input("èª¿æŸ»ã—ãŸã„æŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦")

if st.button("é–¢é€£æŠ€è¡“ææ¡ˆ"):
    if user_input:
        generate_ipc = False
        suggest_technologies(user_input)
    else:
        st.warning("ã¾ãšã¯å…¥åŠ›æ¬„ã«æŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

if st.button("IPCã‚³ãƒ¼ãƒ‰ç”Ÿæˆ"):
    if user_input:
        generate_ipc_codes(user_input)
    else:
        st.warning("ã¾ãšã¯å…¥åŠ›æ¬„ã«æŠ€è¡“é ˜åŸŸã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

# --------------------------------------------
# 10. ãƒ•ãƒƒã‚¿ãƒ¼ã‚„è¿½åŠ æƒ…å ±ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
# --------------------------------------------
st.write("---")
st.write("â€»ã€Œé–¢é€£æŠ€è¡“ææ¡ˆã€ã¨ã€ŒIPCã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€ã¯ãã‚Œãã‚Œåˆ¥ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚")


ãŠã¾ã‘ã®ãƒ†ã‚¹ãƒˆ
# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ä½¿ç”¨ä¾‹
option = st.sidebar.selectbox('ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠ', ['ã‚ªãƒ—ã‚·ãƒ§ãƒ³1', 'ã‚ªãƒ—ã‚·ãƒ§ãƒ³2', 'ã‚ªãƒ—ã‚·ãƒ§ãƒ³3'])
st.write(f'é¸æŠã—ãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ {option} ã§ã™ã€‚')

# ã‚«ãƒ©ãƒ ã®ä½¿ç”¨ä¾‹
column1, column2, column3 = st.columns(3)
with column1:
    st.write('ã“ã‚Œã¯ã‚«ãƒ©ãƒ 1ã§ã™ã€‚')
with column2:
    st.write('ã“ã‚Œã¯ã‚«ãƒ©ãƒ 2ã§ã™ã€‚')
with column3:
    st.write('ã“ã‚Œã¯ã‚«ãƒ©ãƒ 3ã§ã™ã€‚')

col1, col2 = st.columns([2, 3])
col1.metric(label="ãƒ¡ãƒˆãƒªãƒƒã‚¯1", value=123)
col2.metric(label="ãƒ¡ãƒˆãƒªãƒƒã‚¯2", value=456)

col1ã€col2 = st.columns([2ã€3])
with col1:
    st.metric(label="ãƒ¡ãƒˆãƒªãƒƒã‚¯1"ã€value=123)
    st.caption("ã“ã‚Œã¯ãƒ¡ãƒˆãƒªãƒƒã‚¯1ã«é–¢ã™ã‚‹è¿½åŠ ã®æƒ…å ±ã§ã™ã€‚")
with col2:
    st.metric(label="ãƒ¡ãƒˆãƒªãƒƒã‚¯2"ã€value=456)
    st.caption("ã“ã‚Œã¯ãƒ¡ãƒˆãƒªãƒƒã‚¯2ã«é–¢ã™ã‚‹è¿½åŠ ã®æƒ…å ±ã§ã™ã€‚")

with st.expander("ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹"):
    st.write("éè¡¨ç¤ºã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„")
